<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”»åƒä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«ï¼ˆèªè¨¼ç‰ˆï¼‰</title>
  <style>
    /* èªè¨¼ãƒãƒ¼ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .auth-topbar { 
      display:flex; align-items:center; gap:12px; padding:8px 20px; 
      background:#34495e; color:#fff; font-size:0.9rem; border-bottom:1px solid #2c3e50;
    }
    .auth-spacer { flex:1; }
    .auth-logout { 
      background:#e74c3c; border:none; color:#fff; padding:6px 12px; 
      border-radius:4px; cursor:pointer; font-size:0.85rem;
    }
    .auth-notice { 
      padding:12px 20px; background:#fff3cd; color:#856404; 
      border-bottom:1px solid #ffeaa7; text-align:center;
    }

    /* æ—¢å­˜ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', sans-serif; background:#f8f9fa; min-height:100vh; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    .container { width:100%; min-height:100vh; background:#fff; display:flex; flex-direction:column; }
    .header { background:#2c3e50; color:#fff; padding:16px 20px; text-align:center; }
    .header h1 { font-size:1.6rem; margin-bottom:6px; }
    .header .help { font-size:0.9rem; opacity:0.85; }
    .controls { padding:14px 20px; background:#ecf0f1; border-bottom:2px solid #bdc3c7; display:grid; gap:12px; align-items:center; grid-template-columns: 1fr; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .file-input { display:none; }
    .file-label { display:inline-block; background:#3498db; color:#fff; padding:10px 18px; border-radius:18px; cursor:pointer; }
    .info { color:#7f8c8d; font-size:0.9rem; }
    .btn { padding:9px 14px; border:none; border-radius:6px; cursor:pointer; font-size:0.95rem; }
    .btn.save { background:#27ae60; color:#fff; }
    .btn.delete { background:#e74c3c; color:#fff; }
    .btn.reset { background:#95a5a6; color:#fff; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .gallery { flex:1; padding:16px 20px; min-height:0; overflow:auto; }
    .gallery-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(var(--col-width, 220px), 1fr)); gap:16px; }
    .image-item { background:#fff; border:2px solid transparent; border-radius:10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow:hidden; cursor:move; transition: box-shadow .2s, border-color .2s; }
    .image-item.selected { border-color:#e67e22; box-shadow:0 0 0 3px rgba(230,126,34,.25); }
    .image-viewport { position:relative; width:100%; height: var(--img-height, 240px); background:#111; display:flex; align-items:center; justify-content:center; }
    .image-viewport::after { content:""; position:absolute; inset:0; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); pointer-events:none; }
    .image-preview { width:100%; height:100%; object-fit:contain; display:block; background:transparent; }
    .image-info { padding:8px 10px; }
    .image-name { font-size:0.85rem; color:#2c3e50; word-break:break-all; margin-bottom:4px; }
    .image-order { display:inline-block; background:#3498db; color:#fff; padding:2px 8px; border-radius:12px; font-size:0.78rem; font-weight:600; }
    .drag-over { outline: 2px dashed #3498db; outline-offset:-2px; background:#ecf6fe; }
    .progress { height:4px; background:#ecf0f1; border-radius:2px; overflow:hidden; display:none; }
    .progress .bar { height:100%; width:0%; background:#27ae60; transition:width .2s; }
    .progress-info { color:#7f8c8d; font-size:0.9rem; margin-top:4px; display:none; }
    .selection { color:#7f8c8d; font-size:0.9rem; }
    .slider { flex:1; height:8px; }
    .batch-info { background:#e8f5e8; border:1px solid #4caf50; color:#2e7d32; padding:8px 12px; border-radius:6px; font-size:0.85rem; display:none; }
    .add-info { background:#fff3cd; border:1px solid #ffeaa7; color:#856404; padding:6px 10px; border-radius:4px; font-size:0.8rem; display:none; margin-top:4px; }
    @media (max-width: 768px) { .gallery { padding:12px; } .controls { padding:12px; } }
    
    /* è¿½åŠ ï¼šç”»åƒã®ä¿å­˜ç¦æ­¢ */
    img { pointer-events: none; -webkit-user-drag: none; -khtml-user-drag: none; -moz-user-drag: none; -o-user-drag: none; user-drag: none; }
  </style>
</head>
<body oncontextmenu="return false;">
  <!-- èªè¨¼çŠ¶æ…‹è¡¨ç¤ºãƒãƒ¼ -->
  <div class="auth-topbar">
    <div>ğŸ”’ èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ„ãƒ¼ãƒ«</div>
    <div class="auth-spacer"></div>
    <div id="userEmail"></div>
    <button id="authLogoutButton" class="auth-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
  
  <!-- åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³è­¦å‘Š -->
  <div id="multiLoginWarn" class="auth-notice" style="display:none;"></div>

  <!-- æ—¢å­˜ã®ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«æœ¬ä½“ -->
  <div class="container">
    <div class="header">
      <h1>ğŸ–¼ï¸ ç”»åƒä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«ï¼ˆèªè¨¼ç‰ˆï¼‰</h1>
      <div class="help">Ctrl/ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã€Shift/ã‚¯ãƒªãƒƒã‚¯ã§ç¯„å›²é¸æŠã€Deleteã§å‰Šé™¤ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ã‚µã‚¤ã‚ºå¤‰æ›´</div>
    </div>

    <div class="controls">
      <div class="row">
        <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
        <label for="fileInput" class="file-label">ğŸ“ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ é¸æŠ</label>
        <span id="fileCount" class="info"></span>
      </div>
      <div id="addInfo" class="add-info"></div>
      <div id="batchInfo" class="batch-info"></div>
      <div class="row">
        <label for="sizeSlider"><strong>ç”»åƒè¡¨ç¤ºé«˜ã•:</strong></label>
        <input type="range" id="sizeSlider" class="slider" min="120" max="640" value="240">
        <span id="sizeValue" class="info">240px</span>
      </div>
      <div class="row">
        <button id="saveBtn" class="btn save" disabled>ğŸ’¾ ä¸¦ã³æ›¿ãˆã¦ä¿å­˜</button>
        <button id="deleteBtn" class="btn delete" disabled>ğŸ—‘ï¸ é¸æŠç”»åƒã‚’å‰Šé™¤</button>
        <button id="resetBtn" class="btn reset" disabled>ğŸ”„ å…¨ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        <span id="selectionInfo" class="selection"></span>
      </div>
      <div class="progress" id="progress"><div id="progressBar" class="bar"></div></div>
      <div id="progressInfo" class="progress-info"></div>
    </div>

    <div class="gallery">
      <div id="galleryGrid" class="gallery-grid">
        <div class="info">ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <!-- Firebaseèªè¨¼å‡¦ç† -->
  <script type="module">
    // Firebaseãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, updateDoc, collection, getDocs,
      query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // 1) Firebaseè¨­å®šï¼ˆç½®æ›å¿…é ˆï¼‰
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID"
    };

    // åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 2) ç«¯æœ«IDç”Ÿæˆ
    function getOrCreateDeviceId() {
      const key = 'deviceId_v1';
      let id = localStorage.getItem(key);
      if (!id) {
        id = 'dev_' + crypto.getRandomValues(new Uint32Array(4)).join('-');
        localStorage.setItem(key, id);
      }
      return id;
    }

    // 3) åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    async function canEnterTool(user) {
      const deviceId = getOrCreateDeviceId();
      const sessionsCol = collection(db, 'users', user.uid, 'sessions');
      const snap = await getDocs(query(sessionsCol, where('active', '==', true)));

      let otherActive = false;
      snap.forEach(s => {
        const d = s.data();
        if (d.deviceId !== deviceId) otherActive = true;
      });

      if (otherActive) return false;

      // è‡ªåˆ†ã®ç”Ÿå­˜æ›´æ–°
      await updateDoc(doc(db, 'users', user.uid, 'sessions', deviceId), {
        lastSeenAt: serverTimestamp(),
        active: true
      });
      return true;
    }

    // 4) èªè¨¼çŠ¶æ…‹ç›£è¦–
    const warn = document.getElementById("multiLoginWarn");
    const userEmailDiv = document.getElementById("userEmail");
    let sortToolInitialized = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        location.href = 'index.html';
        return;
      }

      userEmailDiv.textContent = user.email;

      const deviceId = getOrCreateDeviceId();
      const sessionRef = doc(db, 'users', user.uid, 'sessions', deviceId);

      await setDoc(sessionRef, {
        active: true,
        deviceId,
        userAgent: navigator.userAgent,
        loggedInAt: serverTimestamp(),
        lastSeenAt: serverTimestamp()
      }, { merge: true });

      const ok = await canEnterTool(user);
      if (!ok) {
        warn.style.display = 'block';
        warn.textContent = 'ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åˆ¥ã®ç«¯æœ«ã§ä½¿ç”¨ä¸­ã§ã™ã€‚ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç„¡åŠ¹ã§ã™ã€‚';
        setTimeout(async () => {
          await signOut(auth);
          location.href = 'index.html';
        }, 3000);
        return;
      }

      // ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ï¼ˆ1å›ã®ã¿ï¼‰
      if (!sortToolInitialized) {
        initializeSortTool();
        sortToolInitialized = true;
      }

      // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé–‹å§‹
      setInterval(async () => {
        const u = auth.currentUser;
        if (!u) return;
        await updateDoc(doc(db, 'users', u.uid, 'sessions', deviceId), {
          lastSeenAt: serverTimestamp(),
          active: true
        });
      }, 60 * 1000);
    });

    // 5) èªè¨¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    document.getElementById('authLogoutButton').addEventListener('click', async () => {
      const u = auth.currentUser;
      try {
        if (u) {
          const deviceId = getOrCreateDeviceId();
          await updateDoc(doc(db, 'users', u.uid, 'sessions', deviceId), {
            active: false,
            lastSeenAt: serverTimestamp()
          });
        }
      } finally {
        await signOut(auth);
        location.href = 'index.html';
      }
    });

    // 6) ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–é–¢æ•°
    function initializeSortTool() {
      // æ—¢å­˜ã®ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«ã®å¤‰æ•°ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«é…ç½®
      window.initSortTool();
    }
  </script>

  <!-- æ—¢å­˜ã®ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«æœ¬ä½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆæœŸåŒ–é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.initSortTool = function() {
      // ===========================================
      // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¿è­·æ©Ÿèƒ½
      // ===========================================
      
      // å³ã‚¯ãƒªãƒƒã‚¯ç¦æ­¢ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦æ±‚
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        const password = prompt('ã“ã®æ“ä½œã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (password === 'orenonana0405') {
          alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ãŸã‚ã€é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„ã€‚\nï¼ˆF12ã‚­ãƒ¼ã¾ãŸã¯Ctrl+Shift+Iï¼‰');
        } else if (password !== null) {
          alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚');
        }
        return false;
      });

      // é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ç³»ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã®ç¦æ­¢
      document.addEventListener('keydown', function(e) {
        // F12ã‚­ãƒ¼
        if (e.key === 'F12') {
          e.preventDefault();
          checkPasswordForDevTools();
          return false;
        }
        
        // Ctrl+Shift+I (é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«)
        if (e.ctrlKey && e.shiftKey && e.key === 'I') {
          e.preventDefault();
          checkPasswordForDevTools();
          return false;
        }
        
        // Ctrl+Shift+C (è¦ç´ é¸æŠ)
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
          e.preventDefault();
          checkPasswordForDevTools();
          return false;
        }
        
        // Ctrl+U (ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è¡¨ç¤º)
        if (e.ctrlKey && e.key === 'u') {
          e.preventDefault();
          checkPasswordForDevTools();
          return false;
        }
        
        // Ctrl+S (ãƒšãƒ¼ã‚¸ä¿å­˜)
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          alert('âŒ ãƒšãƒ¼ã‚¸ã®ä¿å­˜ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚');
          return false;
        }
        
        // Ctrl+A (å…¨é¸æŠ) - éƒ¨åˆ†çš„ã«åˆ¶é™
        if (e.ctrlKey && e.key === 'a') {
          if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            return false;
          }
        }
        
        // Ctrl+C, Ctrl+X (ã‚³ãƒ”ãƒ¼ãƒ»åˆ‡ã‚Šå–ã‚Š) - ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–
        if ((e.ctrlKey && e.key === 'c') || (e.ctrlKey && e.key === 'x')) {
          if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            return false;
          }
        }
      });

      function checkPasswordForDevTools() {
        const password = prompt('é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (password === 'orenonana0405') {
          alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ãŸã‚ã€é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚\næ‰‹å‹•ã§é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚');
        } else if (password !== null) {
          alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚');
        }
      }

      // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã®ç¦æ­¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ä»¥å¤–ï¼‰
      document.addEventListener('selectstart', function(e) {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          return false;
        }
      });

      // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®ç¦æ­¢
      document.addEventListener('dragstart', function(e) {
        if (e.target.tagName === 'IMG') {
          e.preventDefault();
          return false;
        }
      });

      // ç”»åƒä¿å­˜ã®ç¦æ­¢
      document.addEventListener('drop', function(e) {
        e.preventDefault();
        return false;
      });

      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      console.log('%cğŸ”’ ã“ã®ã‚µã‚¤ãƒˆã¯ä¿è­·ã•ã‚Œã¦ã„ã¾ã™', 'color: red; font-size: 20px; font-weight: bold;');
      console.log('%câš ï¸ ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã¯è¨˜éŒ²ã•ã‚Œã¾ã™', 'color: orange; font-size: 14px;');

      // ===========================================
      // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
      // ===========================================

      let images = [];
      let selectedIds = new Set();
      let dragSourceIds = [];
      let draggedElement = null;

      // æšæ•°ãƒ™ãƒ¼ã‚¹ã®è¨­å®š
      const MAX_IMAGES_PER_BATCH = 500; // 500æš per batch
      const MAX_SINGLE_FILE_SIZE = 100 * 1024 * 1024; // 100MB per file

      const fileInput = document.getElementById('fileInput');
      const fileCount = document.getElementById('fileCount');
      const galleryGrid = document.getElementById('galleryGrid');
      const sizeSlider = document.getElementById('sizeSlider');
      const sizeValue = document.getElementById('sizeValue');
      const saveBtn = document.getElementById('saveBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const resetBtn = document.getElementById('resetBtn');
      const progress = document.getElementById('progress');
      const progressBar = document.getElementById('progressBar');
      const progressInfo = document.getElementById('progressInfo');
      const selectionInfo = document.getElementById('selectionInfo');
      const batchInfo = document.getElementById('batchInfo');
      const addInfo = document.getElementById('addInfo');

      fileInput.addEventListener('change', handleFileSelect);
      sizeSlider.addEventListener('input', handleSizeChange);
      saveBtn.addEventListener('click', handleSave);
      deleteBtn.addEventListener('click', handleDelete);
      resetBtn.addEventListener('click', handleReset);
      document.addEventListener('keydown', handleKeyDown);
      galleryGrid.addEventListener('click', handleImageClick);

      // ä¿®æ­£ï¼šãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ é¸æŠï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒï¼‰
      function handleFileSelect(e) {
        const newFiles = Array.from(e.target.files);
        
        if (newFiles.length === 0) return;

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼šæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰+ã‚µã‚¤ã‚ºã®çµ„ã¿åˆã‚ã›ã‚’åé›†
        const existingFileKeys = new Set(
          images.map(img => `${img.name}_${img.size}`)
        );

        // å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const oversizedFiles = newFiles.filter(file => file.size > MAX_SINGLE_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          alert(`âš ï¸ ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯100MBã‚’è¶…ãˆã¦ã„ã‚‹ãŸã‚é™¤å¤–ã•ã‚Œã¾ã™:\n${oversizedFiles.map(f => f.name).join('\n')}`);
        }

        // æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚µã‚¤ã‚ºåˆ¶é™+é‡è¤‡é™¤å¤–ï¼‰
        const validNewFiles = newFiles.filter(file => {
          if (!file || !file.name || !file.size || file.size > MAX_SINGLE_FILE_SIZE) {
            return false;
          }
          const fileKey = `${file.name}_${file.size}`;
          return !existingFileKeys.has(fileKey);
        });

        // é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±è¡¨ç¤º
        const duplicateFiles = newFiles.filter(file => {
          if (!file || !file.name || !file.size || file.size > MAX_SINGLE_FILE_SIZE) {
            return false;
          }
          const fileKey = `${file.name}_${file.size}`;
          return existingFileKeys.has(fileKey);
        });

        if (duplicateFiles.length > 0) {
          console.log('é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ:', duplicateFiles.map(f => f.name));
        }

        // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ—¢å­˜ã®é…åˆ—ã«è¿½åŠ 
        const startIndex = images.length;
        const newImageObjects = validNewFiles.map((file, i) => ({
          file: file,
          name: file.name,
          url: URL.createObjectURL(file),
          id: `img-${Date.now()}-${startIndex + i}`,
          size: file.size,
          type: file.type
        }));

        // é…åˆ—ã«è¿½åŠ 
        images.push(...newImageObjects);

        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¦ï¼šæ¬¡å›é¸æŠã®ãŸã‚ï¼‰
        fileInput.value = '';

        // è¿½åŠ æƒ…å ±ã®è¡¨ç¤º
        showAddInfo(validNewFiles.length, duplicateFiles.length);

        // UIã®æ›´æ–°
        selectedIds.clear();
        updateFileCount();
        updateSelectionInfo();
        showBatchInfo();
        renderGallery();
        updateButtons();
      }

      function showAddInfo(addedCount, duplicateCount) {
        if (addedCount > 0 || duplicateCount > 0) {
          let message = '';
          if (addedCount > 0) {
            message += `âœ… ${addedCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
          }
          if (duplicateCount > 0) {
            if (message) message += 'ã€€';
            message += `âš ï¸ ${duplicateCount}å€‹ã®é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`;
          }
          addInfo.textContent = message;
          addInfo.style.display = 'block';
          
          // 3ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤º
          setTimeout(() => {
            addInfo.style.display = 'none';
          }, 3000);
        }
      }

      function showBatchInfo() {
        if (images.length > MAX_IMAGES_PER_BATCH) {
          const expectedBatches = Math.ceil(images.length / MAX_IMAGES_PER_BATCH);
          batchInfo.style.display = 'block';
          batchInfo.innerHTML = `ğŸ“¦ ${images.length}æšã®ç”»åƒãŒ${expectedBatches}å€‹ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ500æš/zipï¼‰ã«åˆ†å‰²ã•ã‚Œã¾ã™ã€‚`;
        } else {
          batchInfo.style.display = 'none';
        }
      }

      function updateFileCount() {
        const totalSize = images.reduce((sum, img) => sum + img.size, 0);
        const sizeMB = (totalSize / (1024 * 1024)).toFixed(1);
        fileCount.textContent = images.length ? `${images.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ« (${sizeMB}MB) ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™` : '';
      }

      function updateSelectionInfo() {
        const c = selectedIds.size;
        selectionInfo.textContent = c ? `${c}å€‹ã®ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™` : '';
      }

      function renderGallery() {
        if (!images.length) {
          galleryGrid.innerHTML = '<div class="info">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
          return;
        }
        galleryGrid.innerHTML = images.map((img, idx) => {
          const sel = selectedIds.has(img.id) ? 'selected' : '';
          const sizeMB = (img.size / (1024 * 1024)).toFixed(1);
          return `
            <div class="image-item ${sel}" draggable="true" data-id="${img.id}">
              <div class="image-viewport">
                <img src="${img.url}" alt="${img.name}" class="image-preview" onerror="this.style.display='none'">
              </div>
              <div class="image-info">
                <div class="image-name">${img.name} (${sizeMB}MB)</div>
                <span class="image-order">é †ç•ª: ${idx + 1}</span>
              </div>
            </div>`;
        }).join('');
        setupDnD();
        handleSizeChange();
      }

      function setupDnD() {
        document.querySelectorAll('.image-item').forEach(item => {
          item.addEventListener('dragstart', onDragStart);
          item.addEventListener('dragover', onDragOver);
          item.addEventListener('drop', onDrop);
          item.addEventListener('dragend', onDragEnd);
          item.addEventListener('dragenter', e => { if (item !== draggedElement) item.classList.add('drag-over'); });
          item.addEventListener('dragleave', e => item.classList.remove('drag-over'));
        });
      }

      function onDragStart(e) {
        const id = this.dataset.id;
        if (!selectedIds.has(id)) { selectedIds.clear(); selectedIds.add(id); renderGallery(); }
        draggedElement = this;
        dragSourceIds = Array.from(selectedIds);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'drag');
      }
      function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
      function onDrop(e) {
        e.preventDefault(); this.classList.remove('drag-over');
        if (this !== draggedElement) {
          const targetId = this.dataset.id;
          const targetIndex = images.findIndex(i => i.id === targetId);
          const draggedItems = dragSourceIds.map(id => images.find(i => i.id === id));
          images = images.filter(i => !dragSourceIds.includes(i.id));
          images.splice(targetIndex, 0, ...draggedItems);
          selectedIds = new Set(dragSourceIds);
          renderGallery(); updateSelectionInfo();
        }
      }
      function onDragEnd() { document.querySelectorAll('.image-item').forEach(i => i.classList.remove('drag-over')); }

      function handleSizeChange() {
        const h = parseInt(sizeSlider.value, 10);
        sizeValue.textContent = `${h}px`;
        document.documentElement.style.setProperty('--img-height', `${h}px`);
        const colW = Math.round(h * 1.2);
        document.documentElement.style.setProperty('--col-width', `${colW}px`);
      }

      function handleImageClick(e) {
        const item = e.target.closest('.image-item');
        if (!item) return;
        const id = item.dataset.id;
        const isCtrl = e.ctrlKey || e.metaKey; const isShift = e.shiftKey;

        if (isShift && selectedIds.size) {
          const arr = Array.from(selectedIds);
          const last = arr[arr.length - 1];
          const a = images.findIndex(i => i.id === last);
          const b = images.findIndex(i => i.id === id);
          const [s, t] = a < b ? [a, b] : [b, a];
          for (let i = s; i <= t; i++) { selectedIds.add(images[i].id); }
        } else if (isCtrl) {
          if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
        } else { selectedIds.clear(); selectedIds.add(id); }
        updateSelectionInfo(); updateButtons(); renderGallery();
      }

      function handleKeyDown(e) { if ((e.key === 'Delete' || e.key === 'Backspace') && selectedIds.size) { e.preventDefault(); handleDelete(); } }

      function handleDelete() {
        if (!selectedIds.size) return;
        const n = selectedIds.size;
        if (confirm(n === 1 ? 'é¸æŠã•ã‚ŒãŸç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' : `é¸æŠã•ã‚ŒãŸ${n}å€‹ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
          selectedIds.forEach(id => {
            const it = images.find(i => i.id === id);
            if (it && it.url && it.url.startsWith('blob:')) {
              try { URL.revokeObjectURL(it.url); } catch (e) { console.warn('URL revoke failed:', e); }
            }
          });
          images = images.filter(i => !selectedIds.has(i.id));
          selectedIds.clear();
          updateFileCount(); updateSelectionInfo(); updateButtons(); renderGallery(); showBatchInfo();
        }
      }

      // æšæ•°ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒãƒåˆ†å‰²é–¢æ•°
      function createBatchesByCount(images, maxCountPerBatch) {
        const batches = [];
        for (let i = 0; i < images.length; i += maxCountPerBatch) {
          batches.push(images.slice(i, i + maxCountPerBatch));
        }
        return batches;
      }

      // ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–ã•ã‚ŒãŸä¿å­˜å‡¦ç†ï¼ˆ500æš/zipï¼‰
      async function handleSave() {
        if (!images.length) return;

        const invalidImages = images.filter(img => !img.file || !img.name || !img.file.size);
        if (invalidImages.length > 0) {
          alert('âš ï¸ ä¸€éƒ¨ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        saveBtn.disabled = true;
        progress.style.display = 'block';
        progressInfo.style.display = 'block';

        try {
          // 500æšå˜ä½ã§ãƒãƒƒãƒã«åˆ†å‰²
          const batches = createBatchesByCount(images, MAX_IMAGES_PER_BATCH);
          const timestamp = new Date().toISOString().slice(0, 10);

          for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
            const batch = batches[batchIndex];
            const batchSuffix = batches.length > 1 ? `_part${batchIndex + 1}` : '';
            
            progressInfo.textContent = `ZIP ${batchIndex + 1}/${batches.length} (${batch.length}æš) ã‚’å‡¦ç†ä¸­...`;
            
            await processBatch(batch, `sorted_images_${timestamp}${batchSuffix}.zip`, batchIndex, batches.length);
            
            // ãƒãƒƒãƒé–“ã§ã®çŸ­ã„ä¼‘æ¯ã§ãƒ¡ãƒ¢ãƒªè§£æ”¾ã‚’ä¿ƒé€²
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¿ƒé€²ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
            if (window.gc) {
              window.gc();
            }
          }

          const message = batches.length > 1 
            ? `âœ… ${batches.length}å€‹ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ500æš/zipï¼‰ã«åˆ†å‰²ã—ã¦ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼`
            : 'âœ… ç”»åƒã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
          alert(message);

        } catch (error) {
          console.error('Save error:', error);
          alert(`âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\nãƒ¡ãƒ¢ãƒªä¸è¶³ã¾ãŸã¯å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’æ¸›ã‚‰ã™ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚`);
        } finally {
          progress.style.display = 'none';
          progressBar.style.width = '0%';
          progressInfo.style.display = 'none';
          saveBtn.disabled = false;
        }
      }

      // ãƒãƒƒãƒå‡¦ç†é–¢æ•°
      async function processBatch(batch, filename, batchIndex, totalBatches) {
        const zip = new JSZip();
        let arrayBuffer = null;

        for (let i = 0; i < batch.length; i++) {
          const image = batch[i];
          const overallProgress = ((batchIndex * MAX_IMAGES_PER_BATCH + i + 1) / (images.length)) * 100;
          progressBar.style.width = `${Math.min(overallProgress, 100)}%`;

          try {
            if (!image.file || typeof image.file.arrayBuffer !== 'function') {
              console.warn(`Skipping invalid file: ${image.name}`);
              continue;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«åã¯é€£ç•ªã®ã¿ï¼‹å…ƒã®æ‹¡å¼µå­
            const extMatch = image.name.match(/\.([^.]+)$/);
            const ext = extMatch ? extMatch[1] : '';
            const globalIndex = images.indexOf(image);
            const newName = ext ? `${globalIndex + 1}.${ext}` : `${globalIndex + 1}`;

            // ä¸€ã¤ãšã¤å‡¦ç†ã—ã¦ãƒ¡ãƒ¢ãƒªã‚’å³åº§ã«è§£æ”¾
            arrayBuffer = await image.file.arrayBuffer();
            zip.file(newName, arrayBuffer);
            
            // æ˜ç¤ºçš„ã«ãƒ¡ãƒ¢ãƒªè§£æ”¾
            arrayBuffer = null;

          } catch (fileError) {
            console.error(`Error processing file ${image.name}:`, fileError);
          }

          // UIãƒ–ãƒ­ãƒƒã‚¯ã‚’é˜²ããŸã‚ã®çŸ­ã„ä¼‘æ¯
          if (i % 50 === 0) {
            await new Promise(resolve => setTimeout(resolve, 10));
          }
        }

        // ZIPç”Ÿæˆï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªè¨­å®šï¼‰
        const blob = await zip.generateAsync({
          type: 'blob',
          compression: 'DEFLATE',
          compressionOptions: { level: 3 }, // åœ§ç¸®ãƒ¬ãƒ™ãƒ«ã‚’ä¸‹ã’ã¦ãƒ¡ãƒ¢ãƒªç¯€ç´„
          streamFiles: true // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æœ‰åŠ¹
        });

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 1000);
      }

      function handleReset() {
        if (!images.length) return;
        if (confirm('å…¨ã¦ã®ç”»åƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          images.forEach(it => {
            if (it.url && it.url.startsWith('blob:')) {
              try { URL.revokeObjectURL(it.url); } catch (e) { console.warn('URL revoke failed:', e); }
            }
          });
          images = []; selectedIds.clear(); fileInput.value = '';
          batchInfo.style.display = 'none';
          addInfo.style.display = 'none';
          updateFileCount(); updateSelectionInfo(); updateButtons(); renderGallery();
        }
      }

      function updateButtons() { const has = !!images.length; const sel = !!selectedIds.size; saveBtn.disabled = !has; resetBtn.disabled = !has; deleteBtn.disabled = !sel; }

      updateButtons();
    };
  </script>
</body>
</html>
