<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”»åƒä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«</title>
  
  <!-- Firebase compatç‰ˆ CDNï¼ˆç¢ºå®Ÿå‹•ä½œï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* èªè¨¼ç¢ºå®šã¾ã§ç”»é¢ã‚’éš ã™ */
    html.guard-wait { 
      visibility: hidden !important; 
    }
    /* æ—¢å­˜CSS */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', sans-serif; background:#f8f9fa; min-height:100vh; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    .container { width:100%; min-height:100vh; background:#fff; display:flex; flex-direction:column; }
    .header { background:#2c3e50; color:#fff; padding:16px 20px; text-align:center; }
    .header h1 { font-size:1.6rem; margin-bottom:6px; }
    .header .help { font-size:0.9rem; opacity:0.85; }
    .controls { padding:14px 20px; background:#ecf0f1; border-bottom:2px solid #bdc3c7; display:grid; gap:12px; align-items:center; grid-template-columns: 1fr; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .file-input { display:none; }
    .file-label { display:inline-block; background:#3498db; color:#fff; padding:10px 18px; border-radius:18px; cursor:pointer; }
    .info { color:#7f8c8d; font-size:0.9rem; }
    .btn { padding:9px 14px; border:none; border-radius:6px; cursor:pointer; font-size:0.95rem; }
    .btn.save { background:#27ae60; color:#fff; }
    .btn.delete { background:#e74c3c; color:#fff; }
    .btn.reset { background:#95a5a6; color:#fff; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .gallery { flex:1; padding:16px 20px; min-height:0; overflow:auto; }
    .gallery-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(var(--col-width, 220px), 1fr)); gap:16px; }
    .image-item { background:#fff; border:2px solid transparent; border-radius:10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); overflow:hidden; cursor:move; transition: box-shadow .2s, border-color .2s; }
    .image-item.selected { border-color:#e67e22; box-shadow:0 0 0 3px rgba(230,126,34,.25); }
    .image-viewport { position:relative; width:100%; height: var(--img-height, 240px); background:#111; display:flex; align-items:center; justify-content:center; }
    .image-viewport::after { content:""; position:absolute; inset:0; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); pointer-events:none; }
    .image-preview { width:100%; height:100%; object-fit:contain; display:block; background:transparent; }
    .image-info { padding:8px 10px; }
    .image-name { font-size:0.85rem; color:#2c3e50; word-break:break-all; margin-bottom:4px; }
    .image-order { display:inline-block; background:#3498db; color:#fff; padding:2px 8px; border-radius:12px; font-size:0.78rem; font-weight:600; }
    .drag-over { outline: 2px dashed #3498db; outline-offset:-2px; background:#ecf6fe; }
    .progress { height:4px; background:#ecf0f1; border-radius:2px; overflow:hidden; display:none; }
    .progress .bar { height:100%; width:0%; background:#27ae60; transition:width .2s; }
    .progress-info { color:#7f8c8d; font-size:0.9rem; margin-top:4px; display:none; }
    .selection { color:#7f8c8d; font-size:0.9rem; }
    .slider { flex:1; height:8px; }
    .batch-info { background:#e8f5e8; border:1px solid #4caf50; color:#2e7d32; padding:8px 12px; border-radius:6px; font-size:0.85rem; display:none; }
    .add-info { background:#fff3cd; border:1px solid #ffeaa7; color:#856404; padding:6px 10px; border-radius:4px; font-size:0.8rem; display:none; margin-top:4px; }
    @media (max-width: 768px) { .gallery { padding:12px; } .controls { padding:12px; } }
    /* ç”»åƒã®ãƒ‰ãƒ©ãƒƒã‚°ä¿å­˜ã®æŠ‘æ­¢ */
    img { pointer-events: none; -webkit-user-drag: none; user-drag: none; }
  </style>

  <script>
    // Firebaseè¨­å®šï¼ˆç›´æ¥è¨˜è¿°ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyD9D6IE-FdCYOKqVzPpl7E8qK7njnBxqfQ",
      authDomain: "image-sorter-5a77d.firebaseapp.com", 
      projectId: "image-sorter-5a77d",
      storageBucket: "image-sorter-5a77d.appspot.com"
      // messagingSenderIdã¨appIdãŒä¸æ˜ãªã‚‰ä¸€æ—¦çœç•¥ï¼ˆåŸºæœ¬èªè¨¼ã¯å‹•ãï¼‰
    };

    // æœ€åˆã¯ç”»é¢ã‚’éš ã™
    document.documentElement.classList.add('guard-wait');
    
    console.log('FirebaseåˆæœŸåŒ–é–‹å§‹');
    
    let auth, db;
    
    try {
      // FirebaseåˆæœŸåŒ–ï¼ˆcompatç‰ˆï¼‰
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      
      console.log('FirebaseåˆæœŸåŒ–å®Œäº†');

      // ç«¯æœ«IDå–å¾—/ç”Ÿæˆ
      function getOrCreateDeviceId() {
        const key = 'deviceId_v1';
        let id = localStorage.getItem(key);
        if (!id) {
          id = 'dev_' + crypto.getRandomValues(new Uint32Array(4)).join('-');
          localStorage.setItem(key, id);
        }
        return id;
      }

      // å¤šé‡ãƒ­ã‚°ã‚¤ãƒ³é˜²æ­¢ãƒã‚§ãƒƒã‚¯
      async function canEnterTool(user) {
        try {
          const deviceId = getOrCreateDeviceId();
          const col = db.collection('users').doc(user.uid).collection('sessions');
          const snap = await col.where('active', '==', true).get();
          
          let otherActive = false;
          snap.forEach(doc => {
            const data = doc.data();
            if (data.deviceId !== deviceId) {
              otherActive = true;
            }
          });
          
          if (otherActive) return false;
          
          // å…¥å ´è¨±å¯ãªã‚‰ç”Ÿå­˜ã‚µã‚¤ãƒ³æ›´æ–°
          await col.doc(deviceId).set({
            active: true,
            deviceId: deviceId,
            userAgent: navigator.userAgent,
            lastSeenAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          
          return true;
        } catch (error) {
          console.error('canEnterTool error:', error);
          return true; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é€šã™
        }
      }

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      window.signOutEverywhere = async function() {
        try {
          const user = auth.currentUser;
          const deviceId = getOrCreateDeviceId();
          
          if (user && deviceId) {
            await db.collection('users').doc(user.uid).collection('sessions').doc(deviceId).update({
              active: false,
              lastSeenAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          await auth.signOut();
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Signout error:', error);
          window.location.href = 'index.html';
        }
      };

      // èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–
      auth.onAuthStateChanged(async (user) => {
        console.log('èªè¨¼çŠ¶æ…‹å¤‰åŒ–:', user ? `ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿(${user.email})` : 'æœªãƒ­ã‚°ã‚¤ãƒ³');
        
        if (!user) {
          // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
          console.log('æœªãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
          window.location.href = 'index.html';
          return;
        }
        
        // å¤šé‡ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const ok = await canEnterTool(user);
        if (!ok) {
          alert('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åˆ¥ã®ç«¯æœ«ã§ä½¿ç”¨ä¸­ã§ã™ã€‚');
          window.location.href = 'index.html';
          return;
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã€ç”»é¢ã‚’è¡¨ç¤º
        console.log('ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªæ¸ˆã¿ã€ç”»é¢è¡¨ç¤º');
        document.documentElement.classList.remove('guard-wait');
        
        // ç”Ÿå­˜ã‚µã‚¤ãƒ³é€ä¿¡ï¼ˆ1åˆ†ãŠãï¼‰
        setInterval(async () => {
          try {
            const deviceId = getOrCreateDeviceId();
            await db.collection('users').doc(user.uid).collection('sessions').doc(deviceId).update({
              active: true,
              lastSeenAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (error) {
            console.warn('Heartbeat error:', error);
          }
        }, 60 * 1000);
      });
      
    } catch (error) {
      console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã¨ã‚Šã‚ãˆãšç”»é¢ã¯è¡¨ç¤ºï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—å›é¿ï¼‰
      document.documentElement.classList.remove('guard-wait');
    }
  </script>
</head>

<body oncontextmenu="return false;">
  <div class="container">
    <div class="header">
      <h1>ğŸ–¼ï¸ ç”»åƒä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«</h1>
      <div class="help">Ctrl/ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã€Shift/ã‚¯ãƒªãƒƒã‚¯ã§ç¯„å›²é¸æŠã€Deleteã§å‰Šé™¤ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ã‚µã‚¤ã‚ºå¤‰æ›´</div>
    </div>
    
    <div class="controls">
      <div class="row">
        <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
        <label for="fileInput" class="file-label">ğŸ“ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ é¸æŠ</label>
        <span id="fileCount" class="info"></span>
        <button onclick="signOutEverywhere()" class="btn reset">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div id="addInfo" class="add-info"></div>
      <div id="batchInfo" class="batch-info"></div>
      <div class="row">
        <label for="sizeSlider"><strong>ç”»åƒè¡¨ç¤ºé«˜ã•:</strong></label>
        <input type="range" id="sizeSlider" class="slider" min="120" max="640" value="240">
        <span id="sizeValue" class="info">240px</span>
      </div>
      <div class="row">
        <button id="saveBtn" class="btn save" disabled>ğŸ’¾ ä¸¦ã³æ›¿ãˆã¦ä¿å­˜</button>
        <button id="deleteBtn" class="btn delete" disabled>ğŸ—‘ï¸ é¸æŠç”»åƒã‚’å‰Šé™¤</button>
        <button id="resetBtn" class="btn reset" disabled>ğŸ”„ å…¨ã¦ãƒªã‚»ãƒƒãƒˆ</button>
        <span id="selectionInfo" class="selection"></span>
      </div>
      <div class="progress" id="progress"><div id="progressBar" class="bar"></div></div>
      <div id="progressInfo" class="progress-info"></div>
    </div>
    
    <div class="gallery">
      <div id="galleryGrid" class="gallery-grid">
        <div class="info">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <!-- ZIP ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <script>
    // å³ã‚¯ãƒªãƒƒã‚¯åˆ¶å¾¡ã¨ãƒ„ãƒ¼ãƒ«æœ¬ä½“ã¯å…ƒã®ã¾ã¾
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      const password = prompt('ã“ã®æ“ä½œã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (password === 'orenonana0405') {
        alert('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„ãŸã‚ã€é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„ã€‚');
      } else if (password !== null) {
        alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
      }
      return false;
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F12') { e.preventDefault(); return false; }
      if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C')) { e.preventDefault(); return false; }
      if (e.ctrlKey && (e.key === 'u' || e.key === 's')) { e.preventDefault(); return false; }
    });
    
    // ä¸¦ã³æ›¿ãˆãƒ„ãƒ¼ãƒ«æœ¬ä½“ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
    let images = [];
    let selectedIds = new Set();
    let dragSourceIds = [];
    let draggedElement = null;
    const MAX_IMAGES_PER_BATCH = 500;
    const MAX_SINGLE_FILE_SIZE = 100 * 1024 * 1024;
    const fileInput = document.getElementById('fileInput');
    const fileCount = document.getElementById('fileCount');
    const galleryGrid = document.getElementById('galleryGrid');
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValue = document.getElementById('sizeValue');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const resetBtn = document.getElementById('resetBtn');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');
    const progressInfo = document.getElementById('progressInfo');
    const selectionInfo = document.getElementById('selectionInfo');
    const batchInfo = document.getElementById('batchInfo');
    const addInfo = document.getElementById('addInfo');
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆå…ƒã®ã¾ã¾ï¼‰
    fileInput.addEventListener('change', handleFileSelect);
    sizeSlider.addEventListener('input', handleSizeChange);
    saveBtn.addEventListener('click', handleSave);
    deleteBtn.addEventListener('click', handleDelete);
    resetBtn.addEventListener('click', handleReset);
    document.addEventListener('keydown', handleKeyDown);
    galleryGrid.addEventListener('click', handleImageClick);

    // ä»¥ä¸‹ã€å…ƒã®handleFileSelectã€œupdateButtonsé–¢æ•°ã‚’ãã®ã¾ã¾è¿½åŠ 
    function handleFileSelect(e) {
      const newFiles = Array.from(e.target.files);
      if (newFiles.length === 0) return;
      const existingFileKeys = new Set(images.map(img => `${img.name}_${img.size}`));
      const oversizedFiles = newFiles.filter(file => file.size > MAX_SINGLE_FILE_SIZE);
      if (oversizedFiles.length > 0) {
        alert(`âš ï¸ ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯100MBã‚’è¶…ãˆã¦ã„ã‚‹ãŸã‚é™¤å¤–ã•ã‚Œã¾ã™:\n${oversizedFiles.map(f => f.name).join('\n')}`);
      }
      const validNewFiles = newFiles.filter(file => {
        if (!file || !file.name || !file.size || file.size > MAX_SINGLE_FILE_SIZE) return false;
        const key = `${file.name}_${file.size}`;
        return !existingFileKeys.has(key);
      });
      const duplicateFiles = newFiles.filter(file => {
        if (!file || !file.name || !file.size || file.size > MAX_SINGLE_FILE_SIZE) return false;
        const key = `${file.name}_${file.size}`;
        return existingFileKeys.has(key);
      });
      if (duplicateFiles.length > 0) {
        console.log('é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—:', duplicateFiles.map(f => f.name));
      }
      const startIndex = images.length;
      const newObjs = validNewFiles.map((file, i) => ({
        file, name: file.name, url: URL.createObjectURL(file),
        id: `img-${Date.now()}-${startIndex + i}`, size: file.size, type: file.type
      }));
      images.push(...newObjs);
      fileInput.value = '';
      showAddInfo(validNewFiles.length, duplicateFiles.length);
      selectedIds.clear();
      updateFileCount();
      updateSelectionInfo();
      showBatchInfo();
      renderGallery();
      updateButtons();
    }

    // æ®‹ã‚Šã®é–¢æ•°ã‚‚å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨
    function showAddInfo(addedCount, duplicateCount) {
      if (addedCount > 0 || duplicateCount > 0) {
        let message = '';
        if (addedCount > 0) message += `âœ… ${addedCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
        if (duplicateCount > 0) message += (message ? 'ã€€' : '') + `âš ï¸ ${duplicateCount}å€‹ã®é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`;
        addInfo.textContent = message;
        addInfo.style.display = 'block';
        setTimeout(() => { addInfo.style.display = 'none'; }, 3000);
      }
    }

    function showBatchInfo() {
      if (images.length > MAX_IMAGES_PER_BATCH) {
        const expected = Math.ceil(images.length / MAX_IMAGES_PER_BATCH);
        batchInfo.style.display = 'block';
        batchInfo.innerHTML = `ğŸ“¦ ${images.length}æšã®ç”»åƒãŒ${expected}å€‹ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ500æš/zipï¼‰ã«åˆ†å‰²ã•ã‚Œã¾ã™ã€‚`;
      } else {
        batchInfo.style.display = 'none';
      }
    }

    function updateFileCount() {
      const total = images.reduce((s, img) => s + img.size, 0);
      const sizeMB = (total / (1024 * 1024)).toFixed(1);
      fileCount.textContent = images.length ? `${images.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ« (${sizeMB}MB) ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™` : '';
    }

    function updateSelectionInfo() {
      const c = selectedIds.size;
      selectionInfo.textContent = c ? `${c}å€‹ã®ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™` : '';
    }

    function renderGallery() {
      if (!images.length) {
        galleryGrid.innerHTML = '<div class="info">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        return;
      }
      galleryGrid.innerHTML = images.map((img, idx) => {
        const sel = selectedIds.has(img.id) ? 'selected' : '';
        const sizeMB = (img.size / (1024 * 1024)).toFixed(1);
        return `
          <div class="image-item ${sel}" draggable="true" data-id="${img.id}">
            <div class="image-viewport">
              <img src="${img.url}" alt="${img.name}" class="image-preview" onerror="this.style.display='none'">
            </div>
            <div class="image-info">
              <div class="image-name">${img.name} (${sizeMB}MB)</div>
              <span class="image-order">é †ç•ª: ${idx + 1}</span>
            </div>
          </div>`;
      }).join('');
      setupDnD();
      handleSizeChange();
    }

    function setupDnD() {
      document.querySelectorAll('.image-item').forEach(item => {
        item.addEventListener('dragstart', onDragStart);
        item.addEventListener('dragover', onDragOver);
        item.addEventListener('drop', onDrop);
        item.addEventListener('dragend', onDragEnd);
        item.addEventListener('dragenter', e => { if (item !== draggedElement) item.classList.add('drag-over'); });
        item.addEventListener('dragleave', e => item.classList.remove('drag-over'));
      });
    }

    function onDragStart(e) {
      const id = this.dataset.id;
      if (!selectedIds.has(id)) { selectedIds.clear(); selectedIds.add(id); renderGallery(); }
      draggedElement = this;
      dragSourceIds = Array.from(selectedIds);
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', 'drag');
    }

    function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }

    function onDrop(e) {
      e.preventDefault(); this.classList.remove('drag-over');
      if (this !== draggedElement) {
        const targetId = this.dataset.id;
        const targetIndex = images.findIndex(i => i.id === targetId);
        const draggedItems = dragSourceIds.map(id => images.find(i => i.id === id));
        images = images.filter(i => !dragSourceIds.includes(i.id));
        images.splice(targetIndex, 0, ...draggedItems);
        selectedIds = new Set(dragSourceIds);
        renderGallery(); updateSelectionInfo();
      }
    }

    function onDragEnd() { document.querySelectorAll('.image-item').forEach(i => i.classList.remove('drag-over')); }

    function handleSizeChange() {
      const h = parseInt(sizeSlider.value, 10);
      sizeValue.textContent = `${h}px`;
      document.documentElement.style.setProperty('--img-height', `${h}px`);
      const colW = Math.round(h * 1.2);
      document.documentElement.style.setProperty('--col-width', `${colW}px`);
    }

    function handleImageClick(e) {
      const item = e.target.closest('.image-item');
      if (!item) return;
      const id = item.dataset.id;
      const isCtrl = e.ctrlKey || e.metaKey; const isShift = e.shiftKey;
      if (isShift && selectedIds.size) {
        const arr = Array.from(selectedIds);
        const last = arr[arr.length - 1];
        const a = images.findIndex(i => i.id === last);
        const b = images.findIndex(i => i.id === id);
        const [s, t] = a < b ? [a, b] : [b, a];
        for (let i = s; i <= t; i++) { selectedIds.add(images[i].id); }
      } else if (isCtrl) {
        if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
      } else { selectedIds.clear(); selectedIds.add(id); }
      updateSelectionInfo(); updateButtons(); renderGallery();
    }

    function handleKeyDown(e) { if ((e.key === 'Delete' || e.key === 'Backspace') && selectedIds.size) { e.preventDefault(); handleDelete(); } }

    function handleDelete() {
      if (!selectedIds.size) return;
      const n = selectedIds.size;
      if (confirm(n === 1 ? 'é¸æŠã•ã‚ŒãŸç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' : `é¸æŠã•ã‚ŒãŸ${n}å€‹ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        selectedIds.forEach(id => {
          const it = images.find(i => i.id === id);
          if (it && it.url && it.url.startsWith('blob:')) {
            try { URL.revokeObjectURL(it.url); } catch (e) { console.warn('URL revoke failed:', e); }
          }
        });
        images = images.filter(i => !selectedIds.has(i.id));
        selectedIds.clear();
        updateFileCount(); updateSelectionInfo(); updateButtons(); renderGallery(); showBatchInfo();
      }
    }

    function createBatchesByCount(images, maxCountPerBatch) {
      const batches = [];
      for (let i = 0; i < images.length; i += maxCountPerBatch) {
        batches.push(images.slice(i, i + maxCountPerBatch));
      }
      return batches;
    }

    async function handleSave() {
      if (!images.length) return;
      const invalidImages = images.filter(img => !img.file || !img.name || !img.file.size);
      if (invalidImages.length > 0) {
        alert('âš ï¸ ä¸€éƒ¨ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      saveBtn.disabled = true;
      progress.style.display = 'block';
      progressInfo.style.display = 'block';
      try {
        const batches = createBatchesByCount(images, MAX_IMAGES_PER_BATCH);
        const timestamp = new Date().toISOString().slice(0, 10);
        for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
          const batch = batches[batchIndex];
          const batchSuffix = batches.length > 1 ? `_part${batchIndex + 1}` : '';
          progressInfo.textContent = `ZIP ${batchIndex + 1}/${batches.length} (${batch.length}æš) ã‚’å‡¦ç†ä¸­...`;
          await processBatch(batch, `sorted_images_${timestamp}${batchSuffix}.zip`, batchIndex, batches.length);
          await new Promise(resolve => setTimeout(resolve, 100));
          if (window.gc) { window.gc(); }
        }
        const message = batches.length > 1 
          ? `âœ… ${batches.length}å€‹ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ500æš/zipï¼‰ã«åˆ†å‰²ã—ã¦ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼`
          : 'âœ… ç”»åƒã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
        alert(message);
      } catch (error) {
        console.error('Save error:', error);
        alert(`âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\nãƒ¡ãƒ¢ãƒªä¸è¶³ã¾ãŸã¯å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
      } finally {
        progress.style.display = 'none';
        progressBar.style.width = '0%';
        progressInfo.style.display = 'none';
        saveBtn.disabled = false;
      }
    }

    async function processBatch(batch, filename, batchIndex, totalBatches) {
      const zip = new JSZip();
      let arrayBuffer = null;
      for (let i = 0; i < batch.length; i++) {
        const image = batch[i];
        const overallProgress = ((batchIndex * MAX_IMAGES_PER_BATCH + i + 1) / (images.length)) * 100;
        progressBar.style.width = `${Math.min(overallProgress, 100)}%`;
        try {
          if (!image.file || typeof image.file.arrayBuffer !== 'function') {
            console.warn(`Skipping invalid file: ${image.name}`);
            continue;
          }
          const extMatch = image.name.match(/\.([^.]+)$/);
          const ext = extMatch ? extMatch[1] : '';
          const globalIndex = images.indexOf(image);
          const newName = ext ? `${globalIndex + 1}.${ext}` : `${globalIndex + 1}`;
          arrayBuffer = await image.file.arrayBuffer();
          zip.file(newName, arrayBuffer);
          arrayBuffer = null;
        } catch (fileError) {
          console.error(`Error processing file ${image.name}:`, fileError);
        }
        if (i % 50 === 0) {
          await new Promise(resolve => setTimeout(resolve, 10));
        }
      }
      const blob = await zip.generateAsync({
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 3 },
        streamFiles: true
      });
      // Blob URLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      downloadBlobAsFile(blob, filename);
    }

    function downloadBlobAsFile(blob, filename) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 1000);
    }

    function handleReset() {
      if (!images.length) return;
      if (confirm('å…¨ã¦ã®ç”»åƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        images.forEach(it => {
          if (it.url && it.url.startsWith('blob:')) {
            try { URL.revokeObjectURL(it.url); } catch (e) { console.warn('URL revoke failed:', e); }
          }
        });
        images = []; selectedIds.clear(); fileInput.value = '';
        batchInfo.style.display = 'none';
        addInfo.style.display = 'none';
        updateFileCount(); updateSelectionInfo(); updateButtons(); renderGallery();
      }
    }

    function updateButtons() { 
      const has = !!images.length; 
      const sel = !!selectedIds.size; 
      saveBtn.disabled = !has; 
      resetBtn.disabled = !has; 
      deleteBtn.disabled = !sel; 
    }

    updateButtons();
  </script>
</body>
</html>
